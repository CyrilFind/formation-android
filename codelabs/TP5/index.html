
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>TP 5: Images</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="TP5"
                  title="TP 5: Images"
                  environment="web"
                  feedback-link="">
    
      <google-codelab-step label="Afficher une image distante avec Coil" duration="0">
        <ul>
<li>Rendez vous sur le <a href="https://coil-kt.github.io/coil/" target="_blank">repository de Coil</a> et lisez le <code>ReadMe</code></li>
<li>Ajouter les d√©pendances n√©cessaires √† <code>app/build.gradle</code></li>
<li>Ajouter une <code>< ImageView .../></code> dans <code>fragment_tasklist.xml</code> principal qui affichera l&#39;avatar de l&#39;utilisateur</li>
<li>Dans <code>onResume</code>, utiliser Coil pour afficher une image en passant une URL de votre choix, par exemple:</li>
</ul>
<pre><code language="language-kotlin" class="language-kotlin">image_view.load(&#34;https://goo.gl/gEgYUd&#34;)
</code></pre>
<ul>
<li>Trouvez comment utiliser Coil pour afficher l&#39;image sous la forme d&#39;un cercle</li>
</ul>
<h2 is-upgraded>Nouvelle activit√©</h2>
<ul>
<li>Cr√©er un nouveau package <code>userinfo</code></li>
<li>Cr√©ez y une nouvelle activit√© <code>UserInfoActivity</code> et ajoutez la dans le manifest</li>
<li>Remplir son layout:</li>
</ul>
<pre><code language="language-xml" class="language-xml">&lt;LinearLayout 
    xmlns:android=&#34;http://schemas.android.com/apk/res/android&#34;
    xmlns:app=&#34;http://schemas.android.com/apk/res-auto&#34;
    xmlns:tools=&#34;http://schemas.android.com/tools&#34;
    android:orientation=&#34;vertical&#34;
    android:layout_width=&#34;match_parent&#34;
    android:layout_height=&#34;match_parent&#34; &gt;
    &lt;ImageView
        android:id=&#34;@+id/image_view&#34;
        android:layout_width=&#34;match_parent&#34;
        android:layout_height=&#34;wrap_content&#34;
        tools:srcCompat=&#34;@tools:sample/avatars&#34; /&gt;

    &lt;Button
        android:id=&#34;@+id/upload_image_button&#34;
        android:layout_width=&#34;match_parent&#34;
        android:layout_height=&#34;wrap_content&#34;
        android:text=&#34;Choisir une Image&#34; /&gt;

    &lt;Button
        android:id=&#34;@+id/take_picture_button&#34;
        android:layout_width=&#34;match_parent&#34;
        android:layout_height=&#34;wrap_content&#34;
        android:text=&#34;Prendre une photo&#34; /&gt;
&lt;/LinearLayout&gt;
</code></pre>
<ul>
<li>Lancer cette <code>Activity</code> quand on clique sur l&#39;<code>ImageView</code> que vous venez de remplir avec <code>Coil</code></li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Demander la Permission" duration="0">
        <ul>
<li><code>AndroidManifest</code>: ajouter la permission <code>android.permission.CAMERA</code></li>
<li><code>UserInfoActivity</code> : Dans <code>onCreate()</code>, ajouter un <code>onClickListener</code> √† <code>take_picture_button</code> qui appele la m√©thode <code>askCameraPermissionAndOpenCamera()</code></li>
<li>Prenez le temps de lire et comprendre ce pav√© ü§î :</li>
</ul>
<pre><code language="language-kotlin" class="language-kotlin">private val requestPermissionLauncher =
        registerForActivityResult(RequestPermission()) { isGranted: Boolean -&gt;
            if (isGranted) openCamera()
            else showExplanationDialog()
        }

private fun requestCameraPermission() =
        requestPermissionLauncher.launch(Manifest.permission.CAMERA)

private fun askCameraPermissionAndOpenCamera() {
    when {
        ContextCompat.checkSelfPermission(this, Manifest.permission.CAMERA)
                == PackageManager.PERMISSION_GRANTED -&gt; openCamera()
        shouldShowRequestPermissionRationale(Manifest.permission.CAMERA) -&gt; showExplanationDialog()
        else -&gt; requestCameraPermission()
    }
}

private fun showExplanationDialog() {
    AlertDialog.Builder(this).apply {
        setMessage(&#34;On a besoin de la cam√©ra sivoupl√© ! ü•∫&#34;)
        setPositiveButton(&#34;Bon, ok&#34;) { dialogInterface, _ -&gt;
            dialogInterface.dismiss() 
        }
        setCancelable(true)
        show()
    }
}
</code></pre>
<p>‚û°Ô∏è C&#39;est normal que le code ne marche pas tout de suite, il manque des choses</p>


      </google-codelab-step>
    
      <google-codelab-step label="Ouvrir l&#39;appareil photo" duration="0">
        <p>Pour l&#39;ouverture de la cam√©ra, on utilise la nouvelle API:</p>
<pre><code language="language-kotlin" class="language-kotlin">// register
private val takePicture = registerForActivityResult(TakePicturePreview()) { bitmap -&gt;
        val tmpFile = File.createTempFile(&#34;avatar&#34;, &#34;jpeg&#34;)
        tmpFile.outputStream().use {
            bitmap.compress(Bitmap.CompressFormat.JPEG, 100, it)
        }
        handleImage(tmpFile.toUri())
    }

// use
private fun openCamera() = takePicture.launch()
</code></pre>
<p>‚û°Ô∏è Il manque encore une brique !</p>


      </google-codelab-step>
    
      <google-codelab-step label="Uploader l&#39;image captur√©e" duration="0">
        <ul>
<li>Dans l&#39;interface <code>UserWebService</code>, ajouter une nouvelle fonction</li>
</ul>
<pre><code language="language-kotlin" class="language-kotlin">@Multipart
@PATCH(&#34;users/update_avatar&#34;)
suspend fun updateAvatar(@Part avatar: MultipartBody.Part): Response&lt;UserInfo&gt;
</code></pre>
<ul>
<li>Ajouter une fonction pour convertir l&#39;image en <code>MultipartBody.Part</code> afin de pouvoir l&#39;envoyer en HTTP:</li>
</ul>
<pre><code language="language-kotlin" class="language-kotlin">// convert     
private fun convert(uri: Uri) =
    MultipartBody.Part.createFormData(
        name = &#34;avatar&#34;,
        filename = &#34;temp.jpeg&#34;,
        body = contentResolver.openInputStream(uri)!!.readBytes().toRequestBody()
    )
</code></pre>
<ul>
<li>Ajoutez une m√©thode <code>handleImage</code> qui utilise <code>updateAvatar</code> avec <code>convert</code></li>
<li>Modifier la <code>data class UserInfo</code> pour ajouter un champ <code>avatar: String</code> (avec une valeur par d√©faut):  c&#39;est une URL qui sera renvoy√©e depuis le serveur</li>
<li>Enfin au chargement de l&#39;activit√©, afficher l&#39;avatar renvoy√© depuis le serveur:</li>
</ul>
<pre><code language="language-kotlin" class="language-kotlin">    lifecycleScope.launch {
        val userInfo = ...getInfos()
        imageView.load(userInfo.avatar) {
            error(R.drawable.ic_launcher_background) // display something when image request fails
        }
    }
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Acc√©der aux fichiers locaux" duration="0">
        <p>Actuellement, la qualit√© d&#39;image r√©cup√©r√©e de l&#39;appareil photo est faible (car pass√©e dans le code en bitmap)</p>
<p>Am√©liorer cette qualit√© en changeant le fonctionnement pour enregistrer directement l&#39;image dans un fichier...mais c&#39;est un peu compliqu√©:</p>
<p>Vous devrez pour √ßa ajouter un <code>FileProvider</code> dans <code>AndroidManifest.xml</code>:</p>
<pre><code language="language-xml" class="language-xml">&lt;provider
    android:name=&#34;androidx.core.content.FileProvider&#34;
    android:authorities=&#34;${applicationId}.fileprovider&#34;
    android:exported=&#34;false&#34;
    android:grantUriPermissions=&#34;true&#34;&gt;
    &lt;meta-data
        android:name=&#34;android.support.FILE_PROVIDER_PATHS&#34;
        android:resource=&#34;@xml/file_paths&#34; /&gt;
&lt;/provider&gt;
</code></pre>
<p>Cr√©ez <code>app/src/main/res/xml/file_paths.xml</code>:</p>
<pre><code language="language-xml" class="language-xml">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;
&lt;paths &gt;
    &lt;external-path name=&#34;external_files&#34; path=&#34;.&#34;/&gt;
&lt;/paths&gt;
</code></pre>
<ul>
<li>Vous pourrez ensuite utiliser:</li>
</ul>
<pre><code language="language-kotlin" class="language-kotlin">// create a temp file and get a uri for it
private val photoUri by lazy {
    FileProvider.getUriForFile(
        this,
        BuildConfig.APPLICATION_ID +&#34;.fileprovider&#34;,
        File.createTempFile(&#34;avatar&#34;, &#34;.jpeg&#34;, externalCacheDir)

    )
}

// register
private val takePicture = registerForActivityResult(TakePicture()) { success -&gt;
    if (success) handleImage(photoUri)
    else Toast.makeText(this, &#34;Erreur ! üò¢&#34;, Toast.LENGTH_LONG).show()
}

// use
private fun openCamera() = takePicture.launch(photoUri)
</code></pre>
<ul>
<li>Ajouter dans le manifest la permission <code>android.permission.READ_EXTERNAL_STORAGE</code></li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Uploader une image stock√©e" duration="0">
        <p>Permettez √† l&#39;utilisateur d&#39;uploader une image enregistr√©e sur son t√©l√©phone</p>
<pre><code language="language-kotlin" class="language-kotlin">// register
private val pickInGallery = 
    registerForActivityResult(GetContent()) { ... }

// use
pickInGallery.launch(&#34;image/*&#34;)
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="√âdition infos utilisateurs" duration="0">
        <ul>
<li>Comme pr√©cedemment, refactorisez en utilisant un <code>UserInfoViewModel</code> et un <code>UserInfoRepository</code></li>
<li>Dans <code>UserInfoActivity</code>, permettre d&#39;√©diter et d&#39;afficher les informations (nom, pr√©nom, email) en respectant cette architecture</li>
<li>Vous aurez besoin d&#39;ajouter √ßa √† <code>UserWebService</code>:</li>
</ul>
<pre><code language="language-kotlin" class="language-kotlin">@PATCH(&#34;users&#34;)
suspend fun update(@Body user: UserInfo): Response&lt;UserInfo&gt;
</code></pre>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/codelab-elements/native-shim.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/prettify.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>

</body>
</html>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById("arrow-back").href="/formation-android/codelabs/";
            document.getElementById("done").href="/formation-android/codelabs/";
        }, false);
    </script>

    