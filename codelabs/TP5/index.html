
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>TP 5: Images, Permissions, Stockage</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="TP5"
                  title="TP 5: Images, Permissions, Stockage"
                  environment="web"
                  feedback-link="">
    
      <google-codelab-step label="Coil" duration="0">
        <aside class="special"><p>La lib <code>Coil</code> permet d&#39;afficher des images depuis une URL de fa√ßon efficace en g√©rant la taille, le cache, etc... <code>Picasso</code> et <code>Glide</code> sont les alternatives les plus utilis√©es.</p>
</aside>
<ul>
<li>Rendez vous sur le <a href="https://coil-kt.github.io/coil/" target="_blank">repository de Coil</a> et lisez le <code>ReadMe</code></li>
<li>Ajouter les d√©pendances n√©cessaires √† <code>app/build.gradle</code></li>
<li>Ajouter une <code>ImageView</code> qui affichera l&#39;avatar de l&#39;utilisateur dans le layout de la liste (√† cot√© de votre <code>TextView</code> par ex)</li>
<li>Dans <code>onResume</code>, r√©cup√©rez une r√©f√©rence √† cette vue puis utilisez Coil pour afficher une image en passant une URL de votre choix, par exemple:</li>
</ul>
<pre><code language="language-kotlin" class="language-kotlin">avatarImageView.load(&#34;https://goo.gl/gEgYUd&#34;)
</code></pre>
<ul>
<li>Trouvez comment l&#39;image sous la forme d&#39;un cercle avec <code>Coil</code></li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Nouvelle activit√©" duration="0">
        <ul>
<li>Cr√©er un nouveau package <code>user</code></li>
<li>Cr√©ez y une nouvelle activit√© <code>UserInfoActivity</code> et ajoutez la dans le manifest</li>
<li>Remplir son layout:</li>
</ul>
<pre><code language="language-xml" class="language-xml">&lt;LinearLayout
    xmlns:android=&#34;http://schemas.android.com/apk/res/android&#34;
    xmlns:app=&#34;http://schemas.android.com/apk/res-auto&#34;
    xmlns:tools=&#34;http://schemas.android.com/tools&#34;
    android:orientation=&#34;vertical&#34;
    android:layout_width=&#34;match_parent&#34;
    android:layout_height=&#34;match_parent&#34; &gt;
    &lt;ImageView
        android:id=&#34;@+id/image_view&#34;
        android:layout_width=&#34;match_parent&#34;
        android:layout_height=&#34;wrap_content&#34;
        tools:srcCompat=&#34;@tools:sample/avatars&#34; /&gt;

    &lt;Button
        android:id=&#34;@+id/upload_image_button&#34;
        android:layout_width=&#34;match_parent&#34;
        android:layout_height=&#34;wrap_content&#34;
        android:text=&#34;Choisir une Image&#34; /&gt;

    &lt;Button
        android:id=&#34;@+id/take_picture_button&#34;
        android:layout_width=&#34;match_parent&#34;
        android:layout_height=&#34;wrap_content&#34;
        android:text=&#34;Prendre une photo&#34; /&gt;
&lt;/LinearLayout&gt;
</code></pre>
<ul>
<li>Lancer cette <code>Activity</code> quand on clique sur l&#39;<code>ImageView</code> que vous venez de remplir avec <code>Coil</code></li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Demander la Permission" duration="0">
        <ul>
<li><code>AndroidManifest</code>: ajouter la permission <code>android.permission.CAMERA</code></li>
<li>Lisez, utilisez et compl√©tez ce pav√© de code:</li>
</ul>
<pre><code language="language-kotlin" class="language-kotlin"> private val cameraPermissionLauncher =
        registerForActivityResult(RequestPermission()) { accepted -&gt;
            if (accepted) // lancer l&#39;action souhait√©e
            else // afficher une explication
        }

private fun launchCameraWithPermission() {
    val camPermission = Manifest.permission.CAMERA
    val permissionStatus = checkSelfPermission(camPermission)
    val isAlreadyAccepted = permissionStatus == PackageManager.PERMISSION_GRANTED
    val isExplanationNeeded = shouldShowRequestPermissionRationale(camPermission)
    when {
        isAlreadyAccepted -&gt; // lancer l&#39;action souhait√©e
        isExplanationNeeded -&gt; // afficher une explication
        else -&gt; // lancer la demande de permission
    }
}

private fun showExplanation() {
    // ici on construit une pop-up syst√®me (Dialog) pour expliquer la n√©cessit√© de la demande de permission
    AlertDialog.Builder(this)
        .setMessage(&#34;ü•∫ On a besoin de la cam√©ra, vraiment! üëâüëà&#34;)
        .setPositiveButton(&#34;Bon, ok&#34;) { _, _ -&gt; /* ouvrir les param√®tres de l&#39;app */ }
        .setNegativeButton(&#34;Nope&#34;) { dialog, _ -&gt; dialog.dismiss() }
        .show()
}

private fun launchAppSettings() {
    // Cet intent permet d&#39;ouvrir les param√®tres de l&#39;app (pour modifier les permissions d√©j√† refus√©es par ex)
    val intent = Intent(
        Settings.ACTION_APPLICATION_DETAILS_SETTINGS,
        Uri.fromParts(&#34;package&#34;, packageName, null)
    )
    // ici pas besoin de v√©rifier avant car on vise un √©cran syst√®me:
    startActivity(intent)
}

private fun handleImage(imageUri: Uri) {
    // afficher l&#39;image dans l&#39;ImageView
}

private fun launchCamera() {
    // √† compl√©ter √† l&#39;√©tape suivante
}
</code></pre>
<p>Dans <code>onCreate()</code>, faire en sorte que le bouton correspondant ouvre la cam√©ra (en demandant la permission)</p>


      </google-codelab-step>
    
      <google-codelab-step label="Ouvrir l&#39;appareil photo" duration="0">
        <p>Pour l&#39;ouverture de la cam√©ra, on va cr√©er un launcher, comme pr√©c√©demment, mais avec autre &#34;contrat&#34;:</p>
<pre><code language="language-kotlin" class="language-kotlin">// register
private val cameraLauncher = registerForActivityResult(TakePicturePreview()) { bitmap -&gt;
        val tmpFile = File.createTempFile(&#34;avatar&#34;, &#34;jpeg&#34;)
        tmpFile.outputStream().use {
            bitmap.compress(Bitmap.CompressFormat.JPEG, 100, it)
        }
        handleImage(tmpFile.toUri())
    }

// use
private fun launchCamera() {
    cameraLauncher.launch()
}
</code></pre>
<aside class="special"><p>Ici le syst√®me sous jacent va utiliser un <code>Intent</code> implicite demandant au syst√®me d&#39;ouvrir une app permettant de prendre une photo (en g√©n√©ral l&#39;app photo par d√©faut)</p>
</aside>
<p>‚û°Ô∏è Il manque encore une brique !</p>


      </google-codelab-step>
    
      <google-codelab-step label="Uploader l&#39;image captur√©e" duration="0">
        <ul>
<li>Dans l&#39;interface <code>UserWebService</code>, ajouter une nouvelle fonction</li>
</ul>
<pre><code language="language-kotlin" class="language-kotlin">@Multipart
@PATCH(&#34;users/update_avatar&#34;)
suspend fun updateAvatar(@Part avatar: MultipartBody.Part): Response&lt;UserInfo&gt;
</code></pre>
<ul>
<li>Ajouter une fonction pour convertir l&#39;image en <code>MultipartBody.Part</code> afin de pouvoir l&#39;envoyer en HTTP:</li>
</ul>
<pre><code language="language-kotlin" class="language-kotlin">private fun convert(uri: Uri): MultipartBody.Part {
    return MultipartBody.Part.createFormData(
        name = &#34;avatar&#34;,
        filename = &#34;temp.jpeg&#34;,
        body = contentResolver.openInputStream(uri)!!.readBytes().toRequestBody()
    )
}
</code></pre>
<ul>
<li>Dans <code>handleImage</code>, envoyez l&#39;image au serveur avec <code>updateAvatar</code> et <code>convert</code></li>
<li>Modifiez <code>UserInfo</code> pour ajouter un champ <code>val avatar: String?</code>: c&#39;est une URL qui sera renvoy√©e depuis le serveur</li>
<li>Enfin, au chargement de l&#39;activit√©, afficher l&#39;avatar renvoy√© depuis le serveur:</li>
</ul>
<pre><code language="language-kotlin" class="language-kotlin">lifecycleScope.launch {
    val userInfo = ...getInfos()...
    imageView.load(userInfo.avatar) {
        // affiche une image par d√©faut en cas d&#39;erreur:
        error(R.drawable.ic_launcher_background)
    }
}
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Acc√©der aux fichiers locaux" duration="0">
        <p>Actuellement, la qualit√© d&#39;image r√©cup√©r√©e de l&#39;appareil photo est faible (car pass√©e dans le code en bitmap)</p>
<p>Am√©liorer cette qualit√© en changeant le fonctionnement pour enregistrer directement l&#39;image dans un fichier... mais c&#39;est un peu compliqu√© alors on va utiliser <a href="https://google.github.io/modernstorage/mediastore/" target="_blank">MediaStore</a> de la lib <code>modernstorage</code> (faite par Google)</p>
<pre><code language="language-groovy" class="language-groovy">implementation &#34;com.google.modernstorage:modernstorage-mediastore:1.0.+&#34;
</code></pre>
<p>Dans votre nouvelle Activity:</p>
<pre><code language="language-kotlin" class="language-kotlin">val mediaStore by lazy { MediaStoreRepository(this) }
</code></pre>
<ul>
<li>Vous pourrez ensuite utiliser:</li>
</ul>
<pre><code language="language-kotlin" class="language-kotlin">// cr√©er un launcher pour la cam√©ra
private val cameraLauncher =
    registerForActivityResult(TakePicture()) { accepted -&gt;
        val view = // n&#39;importe quelle vue (ex: un bouton, binding.root, window.decorView, ...)
        if (accepted) handleImage()
        else Snackbar.make(view, &#34;√âchec!&#34;, Snackbar.LENGTH_LONG).show()
    }


// utiliser
private lateinit var photoUri: Uri
private fun launchCamera() {
    lifecycleScope.launch {
        photoUri = mediaStore.createMediaUri(
            filename = &#34;picture-${UUID.randomUUID()}.jpg&#34;,
            type = FileType.IMAGE,
            location = SharedPrimary
        ).getOrThrow()
        cameraLauncher.launch(photoUri)
    }
}
</code></pre>
<p>Afin de g√©rer Android 9 et ant√©rieurs, il faut √©galement avoir la permission <code>android.permission.WRITE_EXTERNAL_STORAGE</code>: ajouter la dans <code>AndroidManifest.xml</code> et adaptez le launcher avec <code>RequestMultiplePermissions</code>:</p>
<pre><code language="language-kotlin" class="language-kotlin"> private val permissionAndCameraLauncher = registerForActivityResult(RequestMultiplePermissions()) { results -&gt;
     // pour simplifier on ne fait rien ici, il faudra que le user re-clique sur le bouton
 }

 private fun launchCameraWithPermission() {
        // ...
        val storagePermission = Manifest.permission.WRITE_EXTERNAL_STORAGE
        when {
            mediaStore.canWriteSharedEntries() &amp;&amp; isAlreadyAccepted -&gt;  ...
            // ... 
            else -&gt; permissionAndCameraLauncher.launch(arrayOf(camPermission, storagePermission))
        }
    }

</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Uploader une image stock√©e" duration="0">
        <p>Permettez √† l&#39;utilisateur d&#39;uploader une image enregistr√©e sur son t√©l√©phone</p>
<pre><code language="language-kotlin" class="language-kotlin">// register
private val galleryLauncher = registerForActivityResult(GetContent()) {...}

// use
galleryLauncher.launch(&#34;image/*&#34;)
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="√âdition infos utilisateurs" duration="0">
        <ul>
<li>Comme pr√©c√©demment, re-factorisez en utilisant un <code>UserInfoViewModel</code> et un <code>UserInfoRepository</code></li>
<li>Dans <code>UserInfoActivity</code>, permettre d&#39;√©diter et d&#39;afficher les informations (nom, pr√©nom, email) en respectant cette architecture</li>
<li>Vous aurez besoin d&#39;ajouter √ßa √† <code>UserWebService</code>:</li>
</ul>
<pre><code language="language-kotlin" class="language-kotlin">@PATCH(&#34;users&#34;)
suspend fun update(@Body user: UserInfo): Response&lt;UserInfo&gt;
</code></pre>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/codelab-elements/native-shim.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/prettify.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>

</body>
</html>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById("arrow-back").href="/formation-android/codelabs/";
            document.getElementById("done").href="/formation-android/codelabs/";
        }, false);
    </script>

    