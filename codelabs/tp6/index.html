
<!doctype html>

<html>
<head>
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">
  <meta name="theme-color" content="#4F7DC9">
  <meta charset="UTF-8">
  <title>TP 6: SignUp/Login et Navigation</title>
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Source+Code+Pro:400|Roboto:400,300,400italic,500,700|Roboto+Mono">
  <link rel="stylesheet" href="//fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://storage.googleapis.com/codelab-elements/codelab-elements.css">
  <style>
    .success {
      color: #1e8e3e;
    }
    .error {
      color: red;
    }
  </style>
</head>
<body>
  <google-codelab-analytics gaid="UA-49880327-14"></google-codelab-analytics>
  <google-codelab codelab-gaid=""
                  id="tp6"
                  title="TP 6: SignUp/Login et Navigation"
                  environment="web"
                  feedback-link="">
    
      <google-codelab-step label="Ajout des d√©pendances" duration="0">
        <p>Dans le fichier <code>app/build.gradle</code>, ajouter :</p>
<pre><code language="language-groovy" class="language-groovy">implementation &#34;androidx.core:core-ktx:1.1.0&#34;
implementation &#34;androidx.navigation:navigation-fragment-ktx:2.1.0&#34;
implementation &#34;androidx.navigation:navigation-ui-ktx:2.1.0&#34;
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Nouvelle Activity" duration="0">
        <ul>
<li>Cr√©er une nouvelle Activity : <code>AuthenticationActivity</code></li>
<li>Ajoutez la dans l&#39;<code>AndroidManifest</code> et d√©clarez la comme √©tant le point d&#39;entr√©e de votre application (ce n&#39;est plus MainActivity)</li>
<li>Remplacez le layout associ√© par cette balise <code>< FragmentContainerView...></code>:</li>
</ul>
<pre><code language="language-xml" class="language-xml">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;
&lt;FragmentContainerView
    xmlns:android=&#34;http://schemas.android.com/apk/res/android&#34;
    xmlns:app=&#34;http://schemas.android.com/apk/res-auto&#34;
    android:id=&#34;@+id/nav_host_fragment&#34;
    android:layout_width=&#34;match_parent&#34;
    android:layout_height=&#34;match_parent&#34;
    android:name=&#34;androidx.navigation.fragment.NavHostFragment&#34;
    app:defaultNavHost=&#34;true&#34;
    app:navGraph=&#34;@navigation/nav_graph&#34; /&gt;
</code></pre>
<p>√Ä partir du graphe de navigation (<code>app:navGraph="@navigation/nav_graph"</code>), le <code>NavHostFragment</code> va g√©rer la navigation en rempla√ßant le fragment √† chaque changement d&#39;√©cran.</p>
<p>Ce fichier de navigation n&#39;est pas encore, nous y reviendrons plus tard.</p>


      </google-codelab-step>
    
      <google-codelab-step label="Nouveaux Fragments" duration="0">
        <p>Cr√©er 3 nouveaux fragments et leur layout:</p>
<ul>
<li><code>AuthenticationFragment</code><ul>
<li>contient 2 buttons &#34;Log in&#34; et &#34;Sign Up&#34;</li>
</ul>
</li>
<li><code>LoginFragment</code><ul>
<li>Contient 2 <code>EditText</code>, un pour l&#39;email, le second pour le password et un bouton &#34;Login&#34;</li>
<li>L&#39;attribut <code>android:hint</code> permet d&#39;ajouter des placeholders</li>
<li>L&#39;attribut <code>android:inputType</code> permet de gerer le type d&#39;input (password par exemple)</li>
</ul>
</li>
<li><code>SignupFragment</code><ul>
<li>Plusieurs <code>EditText</code>: <code>firstname, lastname, email, password, password_confirmation</code></li>
<li>Un bouton &#34;Sign Up&#34;</li>
</ul>
</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Navigation" duration="0">
        <ul>
<li>Si le fichier <code>navigation/nav_graph.xml</code> n&#39;existe pas cr√©ez le dans le dossier <code>res</code></li>
<li>Ajouter les 3 fragments pr√©c√©dents</li>
<li>D√©finissez <code>AuthenticationFragment</code> comme <code>Start Destination</code> (avec l&#39;ic√¥ne maison üè†)</li>
<li>D√©finissez ensuite les enchainements entre les fragments: l&#39;<code>AuthenticationFragment</code> permet d&#39;ouvrir les 2 autres</li>
<li>Passez en mode <code>Text</code>, vous devriez remarquer 2 actions dans l&#39;<code>AuthenticationFragment</code>: elles vont permettre la navigation dans le code  grace au <code>NavController</code> avec cette syntaxe:</li>
</ul>
<pre><code language="language-kotlin" class="language-kotlin">findNavController().navigate(R.id.action_authenticationFragment_to_loginFragment)
</code></pre>
<ul>
<li>Dans <code>AuthenticationFragment</code>, ajoutez des clickListener sur les 2 boutons &#34;Log in&#34; et &#34;Sign Up&#34; qui vont executer ces navigations</li>
<li>√Ä pr√©sent, vous pouvez naviguer entre les fragments üéä</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="Login" duration="0">
        <ul>
<li>Cr√©er la <code>data class LoginForm</code> qui contient un email et un password de type <code>String</code></li>
<li>Cr√©er la <code>data class LoginResponse</code> qui contient un token de type <code>String</code></li>
<li>Ajouter un nouveau call r√©seau dans <code>UserWebService</code>:</li>
</ul>
<pre><code language="language-kotlin" class="language-kotlin">@POST(&#34;users/login&#34;)
suspend fun login(@Body user: LoginForm): Response&lt;LoginResponse&gt;
</code></pre>
<ul>
<li>Dans <code>LoginFragment</code> cliquer sur &#34;Log in&#34;, doit: <ul>
<li>V√©rifier que les champs sont remplis</li>
<li>Cr√©er une instance de <code>LoginForm</code></li>
<li>Envoyer le formulaire au serveur via la fonction <code>login</code> de <code>UserService</code></li>
<li>Si le call se passe bien, ajouter le token renvoy√© dans les <code>SharedPreference</code> (cf plus bas) et affichez les taches de l&#39;utilisateur</li>
<li>Sinon, afficher un toast pour expliquer l&#39;erreur:</li>
</ul>
</li>
</ul>
<pre><code language="language-kotlin" class="language-kotlin">Toast.makeText(context, &#34;text&#34;, Toast.LENGTH_LONG).show()
</code></pre>
<h2 is-upgraded>SharedPreference</h2>
<ul>
<li>Cr√©er un fichier <code>Constants.kt</code> qui va contenir les constantes utilis√©s par les <code>SharedPreference</code>:</li>
</ul>
<pre><code language="language-kotlin" class="language-kotlin">const val SHARED_PREF_TOKEN_KEY = &#34;auth_token_key&#34;
</code></pre>
<ul>
<li>Pour stocker le token, la syntaxe est simplifi√©e gr√†ce √† <code>core-ktx</code>: (Normalement il faudrait commencer par un <code>.edit()</code> et finir par un <code>.apply()</code>)</li>
</ul>
<pre><code language="language-kotlin" class="language-kotlin">PreferenceManager.getDefaultSharedPreferences(context).edit {
    putString(SHARED_PREF_TOKEN_KEY, fetchedToken)
}
</code></pre>


      </google-codelab-step>
    
      <google-codelab-step label="Refacto de l&#39;API" duration="0">
        <p>Le but est de remplacer le <code>TOKEN</code> en dur par celui stock√© et le r√©cup√©r√© depuis les <code>SharedPreference</code></p>
<p>Une bonne pratique serait ici l&#39;<a href="https://en.wikipedia.org/wiki/Dependency_injection" target="_blank">injection de d√©pendance</a> mais pour faire simple nous allons transformer <code>Api</code> en singleton et l&#39;initialiser au lancement de l&#39;app en lui passant le <code>Context</code> n√©cessaire pour utiliser les <code>SharedPreference</code>:</p>
<pre><code language="language-kotlin" class="language-kotlin">class Api(private val context: Context) {
    companion object {
        private const val BASE_URL = &#34;https://android-tasks-api.herokuapp.com/api/&#34;
        private const val TOKEN = &#34;votre token&#34;
        lateinit var INSTANCE: Api
    }
    // le reste ne change pas
}
</code></pre>
<ul>
<li>Cr√©er une classe <code>App</code></li>
</ul>
<pre><code language="language-kotlin" class="language-kotlin">class App: Application() {
    override fun onCreate() {
        super.onCreate()
        Api.INSTANCE = Api(this)
    }
}
</code></pre>
<ul>
<li>Dans l&#39;<code>AndroidManifest</code>, ajoutez l&#39;attribut name avec votre classe <code>App</code>:</li>
</ul>
<pre><code language="language-xml" class="language-xml">    &lt;application
        android:name=&#34;.path.to.App&#34;
        .../&gt;
</code></pre>
<ul>
<li>Partout ailleurs remplacer <code>Api</code> par <code>Api.INSTANCE</code></li>
<li>Dans l&#39;api, remplacer la <code>const TOKEN</code> par une fonction qui r√©cupere celui qui est stock√©:</li>
</ul>
<pre><code language="language-kotlin" class="language-kotlin">PreferenceManager.getDefaultSharedPreferences(context).getString(SHARED_PREF_TOKEN_KEY, &#34;&#34;)
</code></pre>
<ul>
<li>Utilisez cette fonction dans l&#39;<code>interceptor</code> de votre <code>okHttpClient</code></li>
</ul>
<pre><code language="language-kotlin" class="language-kotlin">&#34;Authorization&#34;, &#34;Bearer ${getToken()}&#34;
</code></pre>
<ul>
<li>Tout devrait fonctionner ! üôå</li>
</ul>


      </google-codelab-step>
    
      <google-codelab-step label="SignUp" duration="0">
        <p>Faire comme pour le login mais avec une <code>data class SignUpForm</code> qui contient: <code>firstname, lastname, email, password, password_confirmation</code></p>


      </google-codelab-step>
    
      <google-codelab-step label="Un petit coup de polish" duration="0">
        <h2 is-upgraded>Redirection</h2>
<p>Lorsque le user relance son application, il faut lui afficher directement la liste des t√¢ches: v√©rifier dans l&#39;<code>AuthenticationFragment</code> si un token existe</p>
<ul>
<li><a href="https://developer.android.com/guide/navigation/navigation-conditional" target="_blank">Documentation</a></li>
</ul>
<h2 is-upgraded>D√©connexion</h2>
<p>Ajouter un bouton pour se d√©connecter qui efface le token dans les <code>SharedPreference</code> et renvoie au d√©but de l&#39;Authentification</p>
<h2 is-upgraded>Ajout et √âdition</h2>
<p>Suivez les m√™mes √©tapes pour remplacer la navigation des TDs pr√©c√©dents avec des <code>Intent</code> explicites par cette nouvelle navigation:</p>
<ul>
<li>Remplacez le <code>< FragmentContainerView></code> dans <code>MainActivity</code> par le <code>< NavHostFragment></code> de <code>AuthenticationActivity</code> et supprimmez <code>AuthenticationActivity</code></li>
<li>Ajoutez <code>TaskListFragment</code> au graphe de navigation</li>
<li>Transformez <code>TaskActivity</code> en <code>TaskFragment</code> en adaptant les <code>override</code> et ajoutez le au graphe</li>
<li>Faites pareil pour <code>UserInfoActivity</code></li>
<li>La destination de d√©part doit √™tre la task list et rediriger vers l&#39;authent quand il n&#39;y a pas d&#39;utilisateur</li>
<li>Pour communiquer entre Fragments vous pouvez utiliser: <ul>
<li>un <code>Bundle</code> pass√© en 2nd argument de <code>navigate()</code> et r√©cup√©r√© de l&#39;autre c√¥t√© avec <code>requireArguments()</code></li>
<li>les <code>savedStateHandle</code> (<a href="https://stackoverflow.com/a/62320979/3466492" target="_blank">exemple</a>)</li>
<li>en faisant <code>by activityViewModels()</code> ou <code>by navGraphViewModels(R.id.nav_graph)</code> au lieu de <code>by viewModels()</code> vous pouvez partager une instance unique d&#39;un viewmodel au sein des Fragments d&#39;une m√™me Activity ce qui √©vite des allers-retours de donn√©es entre fragments</li>
</ul>
</li>
</ul>


      </google-codelab-step>
    
  </google-codelab>

  <script src="https://storage.googleapis.com/codelab-elements/native-shim.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/custom-elements.min.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/prettify.js"></script>
  <script src="https://storage.googleapis.com/codelab-elements/codelab-elements.js"></script>
  <script src="//support.google.com/inapp/api.js"></script>

</body>
</html>
